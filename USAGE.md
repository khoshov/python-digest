# Руководство по использованию Python Digest

## Настройка проекта

### 1. Установка зависимостей

```bash
pip install -e .
```

### 2. Настройка переменных окружения

Скопируйте `.env.example` в `.env` и заполните:

```bash
cp .env.example .env
```

Обязательные переменные:
- `DEEPSEEK_API_KEY` - ключ для DeepSeek API (фильтрация и копирайтинг)

Опциональные:
- `GOOGLE_API_KEY` и `GOOGLE_CSE_ID` - для Google Custom Search
- `OPENAI_API_KEY` - для генерации изображений
- `SMTP_*` - для отправки email уведомлений

### 3. Инициализация базы данных

```bash
python manage.py migrate
```

### 4. Создание суперпользователя

```bash
python manage.py createsuperuser
```

## Настройка через админку

### 1. Создание проекта

1. Откройте админку: `http://localhost:8000/admin/`
2. Перейдите в раздел "Проекты"
3. Создайте новый проект:
   - **Название** - имя вашего проекта (например, "Python Digest Weekly")
   - **Промпты** - можно оставить по умолчанию или кастомизировать
   - **Период RSS** - за какой период собирать новости (по умолчанию 168 часов = 7 дней)
   - **Максимум статей** - сколько статей брать с одного источника
   - **Максимум постов** - сколько финальных постов создавать
   - **Флаги** - включите нужные функции (RSS, Google News, генерация изображений, email)
   - **Активный** - отметьте галочку, чтобы сделать проект активным

### 2. Добавление RSS источников

1. Перейдите в раздел "RSS источники"
2. Добавьте RSS ленты для сбора статей:
   - **Проект** - выберите проект, к которому относится источник
   - **Название RSS источника** - название RSS ленты (например, "Python.org Blog")
   - **URL RSS ленты** - полный URL RSS фида
   - **Приоритет** - 1-10 (1 = самый высокий)
   - **Активен** - отметьте галочку

Примеры RSS лент для Python:
- https://www.python.org/feeds/python.rss/ - официальный блог Python
- https://realpython.com/atom.xml - Real Python
- https://pyfound.blogspot.com/feeds/posts/default - Python Software Foundation
- https://habr.com/ru/rss/all/ - Хабр (все статьи)
- https://planetpython.org/rss20.xml - Planet Python

**⚠️ Важно**:
- URL должен указывать на RSS/Atom фид, а не на обычную веб-страницу
- Неправильно: `https://habr.com` (это главная страница)
- Правильно: `https://habr.com/ru/rss/all/` (это RSS лента)

**Примечание**: RSS источники используются для сбора статей из RSS лент. Каждый проект может иметь свой набор источников.

### 3. Добавление ключевых слов (для Google CSE)

1. Перейдите в раздел "Ключевые слова (Google CSE)"
2. Добавьте ключевые слова для поиска через Google Custom Search:
   - **Проект** - выберите проект, к которому относится ключевое слово
   - **Ключевое слово (для Google CSE)** - слово или фраза для поиска (например, "Django", "FastAPI", "Python 3.13")
   - **Приоритет** - 1-5 (1 = самый высокий)
   - **Активно** - отметьте галочку

**Примечание**: Ключевые слова используются только для поиска через Google Custom Search Engine (CSE). Для RSS используются источники из предыдущего шага.

## Запуск пайплайна

### Список доступных проектов

```bash
python manage.py run_digest --list-projects
```

### Запуск для активного проекта

```bash
python manage.py run_digest
```

### Запуск для конкретного проекта

```bash
python manage.py run_digest --project-id 1
```

## Результаты

Результаты работы пайплайна сохраняются в:
- **База данных** - модели `DigestRun`, `Article`, `GeneratedPost`
- **Файлы** - markdown файлы и изображения (если включено)

## Кастомизация промптов

### Через админку (для конкретного проекта)

Отредактируйте поля промптов в админке Django для нужного проекта.

### Глобально (для всех новых проектов)

Отредактируйте файл `apps/digest/prompts.py`:

```python
FILTER_SYSTEM_PROMPT = """Ваш кастомный системный промпт"""

FILTER_USER_PROMPT = """Ваш кастомный промпт
Используйте переменные: {title}, {summary}, {url}, {format_instructions}
"""
```

## Архитектура

```
┌─────────────┐
│   Project   │ ← Настройки из БД
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│     Pipeline Runner             │
│  ┌──────────────────────────┐   │
│  │  1. Scout (сбор)         │   │
│  │     - RSS feeds          │   │
│  │     - Google Search      │   │
│  └──────────────────────────┘   │
│  ┌──────────────────────────┐   │
│  │  2. Filter (фильтрация)  │   │
│  │     - DeepSeek API       │   │
│  │     - Кастомные промпты  │   │
│  └──────────────────────────┘   │
│  ┌──────────────────────────┐   │
│  │  3. Copywriter (посты)   │   │
│  │     - DeepSeek API       │   │
│  │     - Кастомные промпты  │   │
│  └──────────────────────────┘   │
│  ┌──────────────────────────┐   │
│  │  4. Image Generator      │   │
│  │     - OpenAI DALL-E      │   │
│  └──────────────────────────┘   │
└─────────────────────────────────┘
       │
       ▼
┌─────────────┐
│   Results   │ → БД + Файлы
└─────────────┘
```

## Troubleshooting

### Ошибка "Нет активного проекта"

Создайте проект в админке и отметьте его как активный.

### Ошибка "DEEPSEEK_API_KEY не установлен"

Добавьте ключ в файл `.env`:
```
DEEPSEEK_API_KEY=your-api-key-here
```

### Не собираются статьи

Проверьте:
1. **Для RSS**: Добавлены ли RSS источники (и активны ли они) + включен ли `enable_rss_news` в проекте
2. **Для Google CSE**: Добавлены ли ключевые слова (и активны ли они) + включен ли `enable_google_news` в проекте
3. Правильно ли настроены API ключи в `.env`:
   - `DEEPSEEK_API_KEY` - обязательно для фильтрации и копирайтинга
   - `GOOGLE_API_KEY` и `GOOGLE_CSE_ID` - нужны только для Google Search
4. Доступны ли RSS ленты (проверьте URLs в браузере)

### Все статьи отклоняются фильтром

Попробуйте:
1. Отредактировать промпты фильтра в админке
2. Снизить требования к релевантности
3. Проверить логи для понимания причин отклонения
